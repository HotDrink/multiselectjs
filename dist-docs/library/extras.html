<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>MultiselectJS &#x2014; extras.org</title>
<!-- 2015-08-21 Fri 22:38 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Jaakko JÃ¤rvi" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<style>body { font-family: Arial, Verdana, Helvetica, sans-serif; }</style>
<style>.org-src-name { font-weight: normal; text-decoration: overline underline;  font-family: monospace; margin-top: 1cm; }</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">MultiselectJS &#x2014; extras.org</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Introduction</a>
<ul>
<li><a href="#sec-1-1">1.1. Points, lines, and rectangles</a></li>
<li><a href="#sec-1-2">1.2. Drawing anchors, cursors, and rubber bands on Canvas</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This file contains definitions that are used in the examples, demos, and tutorials.
Two files are generated: <code>rectangle.js</code> and <code>drawing.hs</code>.
The latter depends on the former, and imports it with <code>require</code>.
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Points, lines, and rectangles</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">

<pre class="src src-js">  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">public functions of the Rectangle module</span>
  module.exports = {
    rect: rect,
    point: point,
    midPoint: midPoint,
    getOffsetRect: getOffsetRect,
    getOffsetRects: getOffsetRects,
    pointInRect: pointInRect,
    pointInRects: pointInRects,
    findRectOfPoint: findRectOfPoint,
    pointToRect: pointToRect,
    union: union,
    intersect: intersect,
    intersectWithAny: intersectWithAny,
    width: width,
    height: height,
    lineIntersect: lineIntersect,
    lineRectIntersect: lineRectIntersect,
    distance: distance,
    distanceSquared: distanceSquared,
    distanceToRectSquared: distanceToRectSquared,
    isPointBelowRect: isPointBelowRect,
    isPointAboveRect: isPointAboveRect,
    isPointLeftOfRect: isPointLeftOfRect,
    isPointRightOfRect: isPointRightOfRect,
    within: within
  };

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">within</span>(<span style="color: #BA36A5;">x</span>, <span style="color: #BA36A5;">b</span>, <span style="color: #BA36A5;">e</span>) {
    <span style="color: #0000FF;">return</span> x &gt;= Math.min(b, e) &amp;&amp; x &lt;= Math.max(b, e);
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">relativeToParent</span>(<span style="color: #BA36A5;">pRect</span>, <span style="color: #BA36A5;">eRect</span>) {
    <span style="color: #0000FF;">return</span> {
      left: eRect.left - pRect.left,
      top: eRect.top - pRect.top,
      right: eRect.right - pRect.left,
      bottom: eRect.bottom - pRect.top
    }
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">getOffsetRects</span>(<span style="color: #BA36A5;">parent</span>, <span style="color: #BA36A5;">elem</span>) {
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">parentBox</span> = parent.getBoundingClientRect();
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">boxes</span> = elem.getClientRects();
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">res</span> = $.map(boxes, <span style="color: #0000FF;">function</span> (<span style="color: #BA36A5;">box</span>) { <span style="color: #0000FF;">return</span> relativeToParent(parentBox, box); });
    <span style="color: #0000FF;">return</span> res;
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">getOffsetRect</span>(<span style="color: #BA36A5;">parent</span>, <span style="color: #BA36A5;">elem</span>) {
    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">return elem's bounding box in relation to paren's top left corner</span>
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">parentBox</span> = parent.getBoundingClientRect();
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">box</span> = elem.getBoundingClientRect();
  
    <span style="color: #0000FF;">return</span> {
      left: box.left - parentBox.left,
      top: box.top - parentBox.top,
      right: box.right - parentBox.left,
      bottom: box.bottom - parentBox.top
    }
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">rect</span>(<span style="color: #BA36A5;">p1</span>, <span style="color: #BA36A5;">p2</span>) {
    <span style="color: #0000FF;">return</span> { 
      left: Math.min(p1.x, p2.x),
      top: Math.min(p1.y, p2.y),
      right: Math.max(p1.x, p2.x),
      bottom: Math.max(p1.y, p2.y)
    };        
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">point</span>(<span style="color: #BA36A5;">x</span>, <span style="color: #BA36A5;">y</span>) {
    <span style="color: #0000FF;">return</span> { x: x, y: y };        
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">midPoint</span> (<span style="color: #BA36A5;">r</span>) {
    <span style="color: #0000FF;">return</span> { x: (r.left + r.right)/2, 
             y: (r.top + r.bottom)/2 };
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">pointInRect</span> (<span style="color: #BA36A5;">p</span>, <span style="color: #BA36A5;">r</span>) {
    <span style="color: #0000FF;">return</span> p.x &gt;= r.left &amp;&amp; p.x &lt;= r.right
      &amp;&amp; p.y &gt;= r.top &amp;&amp; p.y &lt;= r.bottom; 
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">pointInRects</span> (<span style="color: #BA36A5;">p</span>, <span style="color: #BA36A5;">rs</span>) {
    <span style="color: #0000FF;">for</span> (<span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">i</span> = 0; i &lt; rs.length; ++i)
      <span style="color: #0000FF;">if</span> (pointInRect(p, rs[i])) <span style="color: #0000FF;">return</span> <span style="color: #8b1a1a;">true</span>;
    <span style="color: #0000FF;">return</span> <span style="color: #8b1a1a;">false</span>;
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">findRectOfPoint</span> (<span style="color: #BA36A5;">p</span>, <span style="color: #BA36A5;">rs</span>) {
    <span style="color: #0000FF;">for</span> (<span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">i</span> = 0; i &lt; rs.length; ++i)
      <span style="color: #0000FF;">if</span> (pointInRect(p, rs[i])) <span style="color: #0000FF;">return</span> rs[i];
    <span style="color: #0000FF;">return</span> <span style="color: #8b1a1a;">undefined</span>;
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">isPointBelowRect</span>(<span style="color: #BA36A5;">p</span>, <span style="color: #BA36A5;">r</span>) { 
    <span style="color: #0000FF;">return</span> p.y &gt;= r.bottom; 
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">isPointAboveRect</span>(<span style="color: #BA36A5;">p</span>, <span style="color: #BA36A5;">r</span>) { 
    <span style="color: #0000FF;">return</span> p.y &lt;= r.top; 
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">isPointLeftOfRect</span>(<span style="color: #BA36A5;">p</span>, <span style="color: #BA36A5;">r</span>) { 
    <span style="color: #0000FF;">return</span> p.x &lt;= r.left; 
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">isPointRightOfRect</span>(<span style="color: #BA36A5;">p</span>, <span style="color: #BA36A5;">r</span>) { 
    <span style="color: #0000FF;">return</span> p.x &gt;= r.right; 
  }

  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">a zero width, zero hight rectangle at point</span>
  <span style="color: #0000FF;">function</span> <span style="color: #006699;">pointToRect</span> (<span style="color: #BA36A5;">point</span>) {
    <span style="color: #0000FF;">return</span> { left: point.x, top: point.y, 
             right: point.x, bottom: point.y };
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">distance</span> (<span style="color: #BA36A5;">p1</span>, <span style="color: #BA36A5;">p2</span>) {
    <span style="color: #0000FF;">return</span> Math.sqrt(distanceSquared(p1, p2)); 
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">distanceSquared</span> (<span style="color: #BA36A5;">p1</span>, <span style="color: #BA36A5;">p2</span>) {
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">dx</span> = p2.x - p1.x;
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">dy</span> = p2.y - p1.y;
    <span style="color: #0000FF;">return</span> (dx * dx) + (dy * dy); 
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">distanceToRectSquared</span> (<span style="color: #BA36A5;">p</span>, <span style="color: #BA36A5;">r</span>) {
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">cand</span> = Math.min(
      distanceSquared(p, {x: r.left, y: r.top}),
      distanceSquared(p, {x: r.left, y: r.bottom}),
      distanceSquared(p, {x: r.right, y: r.top}),
      distanceSquared(p, {x: r.right, y: r.bottom})
    );
    <span style="color: #0000FF;">if</span> (p.x &gt; r.left &amp;&amp; p.x &lt; r.right) 
      <span style="color: #0000FF;">return</span> Math.min(cand, Math.abs(p.y - r.top), Math.abs(p.y - r.bottom));
    <span style="color: #0000FF;">if</span> (p.y &gt; r.top &amp;&amp; p.y &lt; r.bottom) 
      <span style="color: #0000FF;">return</span> Math.min(cand, Math.abs(p.x - r.left), Math.abs(p.x - r.right));
    <span style="color: #0000FF;">return</span> cand;
  }

  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">the smallest rectangle that includes r1 and r2</span>
  <span style="color: #0000FF;">function</span> <span style="color: #006699;">union</span> (<span style="color: #BA36A5;">r1</span>, <span style="color: #BA36A5;">r2</span>) {
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">left</span> = Math.min(r1.left, r2.left);
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">top</span> = Math.min(r1.top, r2.top);
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">right</span> = Math.max(r1.right, r2.right);
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">bottom</span> = Math.max(r1.bottom, r2.bottom);
    <span style="color: #0000FF;">return</span> {
      left: left,
      top: top, 
      right: right,
      bottom: bottom
    };
  }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">width</span> (<span style="color: #BA36A5;">r</span>) { <span style="color: #0000FF;">return</span> r.right - r.left; }
  <span style="color: #0000FF;">function</span> <span style="color: #006699;">height</span> (<span style="color: #BA36A5;">r</span>) { <span style="color: #0000FF;">return</span> r.bottom - r.top; }

  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">do r1 and r2 intersect?</span>
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">two zero-width and heigth rectangles do </span>
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">not intersect, even if they are the same point</span>
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">FIXME: this is not quite the right behavior</span>
  <span style="color: #0000FF;">function</span> <span style="color: #006699;">intersect</span> (<span style="color: #BA36A5;">r1</span>, <span style="color: #BA36A5;">r2</span>) {
    <span style="color: #0000FF;">return</span> r1.left &lt; r2.right
      &amp;&amp; r1.right &gt; r2.left
      &amp;&amp; r1.top &lt; r2.bottom
      &amp;&amp; r1.bottom &gt; r2.top;
  };

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">intersectWithAny</span> (<span style="color: #BA36A5;">r</span>, <span style="color: #BA36A5;">rs</span>) {
    <span style="color: #0000FF;">for</span> (<span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">i</span> = 0; i &lt; rs.length; ++i)
      <span style="color: #0000FF;">if</span> (intersect(r, rs[i])) <span style="color: #0000FF;">return</span> <span style="color: #8b1a1a;">true</span>;
    <span style="color: #0000FF;">return</span> <span style="color: #8b1a1a;">false</span>;
  }



  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">PORTED FROM:</span>

<span style="color: #8D8D84; font-style: italic;">   * lines_intersect:  AUTHOR: Mukesh Prasad</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   *   This function computes whether two line segments,</span>
<span style="color: #8D8D84; font-style: italic;">   *   respectively joining the input points (x1,y1) -- (x2,y2)</span>
<span style="color: #8D8D84; font-style: italic;">   *   and the input points (x3,y3) -- (x4,y4) intersect.</span>
<span style="color: #8D8D84; font-style: italic;">   *   If the lines intersect, the output variables x, y are</span>
<span style="color: #8D8D84; font-style: italic;">   *   set to coordinates of the point of intersection.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   *   All values are in integers.  The returned value is rounded</span>
<span style="color: #8D8D84; font-style: italic;">   *   to the nearest integer point.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   *   If non-integral grid points are relevant, the function</span>
<span style="color: #8D8D84; font-style: italic;">   *   can easily be transformed by substituting floating point</span>
<span style="color: #8D8D84; font-style: italic;">   *   calculations instead of integer calculations.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   *   Entry</span>
<span style="color: #8D8D84; font-style: italic;">   *        x1, y1,  x2, y2   Coordinates of endpoints of one segment.</span>
<span style="color: #8D8D84; font-style: italic;">   *        x3, y3,  x4, y4   Coordinates of endpoints of other segment.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   *   Exit</span>
<span style="color: #8D8D84; font-style: italic;">   *        x, y              Coordinates of intersection point.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   *   The value returned by the function is one of:</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   *        DONT_INTERSECT    0</span>
<span style="color: #8D8D84; font-style: italic;">   *        DO_INTERSECT      1</span>
<span style="color: #8D8D84; font-style: italic;">   *        COLLINEAR         2</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * Error conditions:</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   *     Depending upon the possible ranges, and particularly on 16-bit</span>
<span style="color: #8D8D84; font-style: italic;">   *     computers, care should be taken to protect from overflow.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   *     In the following code, 'long' values have been used for this</span>
<span style="color: #8D8D84; font-style: italic;">   *     purpose, instead of 'int'.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   */</span>

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">sameSigns</span>(<span style="color: #BA36A5;">a</span>, <span style="color: #BA36A5;">b</span>) { <span style="color: #0000FF;">return</span> a &gt;= 0 &amp;&amp; b &gt;= 0 || a &lt; 0 &amp;&amp; b &lt; 0; }

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">lineIntersect</span>( <span style="color: #BA36A5;">p1</span>,   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">First line segment */</span>
                          <span style="color: #BA36A5;">p2</span>,
                          <span style="color: #BA36A5;">p3</span>,   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Second line segment */</span>
                          <span style="color: #BA36A5;">p4</span>,
                          p5    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Output value:</span>
<span style="color: #8D8D84; font-style: italic;">                                 * point of intersection */</span>
                        )
  {

    <span style="color: #0000FF;">const</span> <span style="color: #BA36A5;">DONT_INTERSECT</span> = 0;
    <span style="color: #0000FF;">const</span> <span style="color: #BA36A5;">DO_INTERSECT</span> = 1;
    <span style="color: #0000FF;">const</span> <span style="color: #BA36A5;">COLLINEAR</span> = 2;

    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">a1</span>, <span style="color: #BA36A5;">a2</span>, <span style="color: #BA36A5;">b1</span>, <span style="color: #BA36A5;">b2</span>, <span style="color: #BA36A5;">c1</span>, <span style="color: #BA36A5;">c2</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Coefficients of line eqns. */</span>
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">r1</span>, <span style="color: #BA36A5;">r2</span>, <span style="color: #BA36A5;">r3</span>, <span style="color: #BA36A5;">r4</span>;         <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">'Sign' values */</span>
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">denom</span>, <span style="color: #BA36A5;">offset</span>, <span style="color: #BA36A5;">num</span>;     <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Intermediate values */</span>

    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Compute a1, b1, c1, where line joining points 1 and 2</span>
<span style="color: #8D8D84; font-style: italic;">     * is "a1 x  +  b1 y  +  c1  =  0".</span>
<span style="color: #8D8D84; font-style: italic;">     */</span>
  
    a1 = p2.y - p1.y;
    b1 = p1.x - p2.x;
    c1 = p2.x * p1.y - p1.x * p2.y;

    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Compute r3 and r4.</span>
<span style="color: #8D8D84; font-style: italic;">     */</span>
  
  
    r3 = a1 * p3.x + b1 * p3.y + c1;
    r4 = a1 * p4.x + b1 * p4.y + c1;
  
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Check signs of r3 and r4.  If both point 3 and point 4 lie on</span>
<span style="color: #8D8D84; font-style: italic;">     * same side of line 1, the line segments do not intersect.</span>
<span style="color: #8D8D84; font-style: italic;">     */</span>
  
    <span style="color: #0000FF;">if</span> ( r3 != 0 &amp;&amp;
         r4 != 0 &amp;&amp;
         sameSigns( r3, r4 ))
      <span style="color: #0000FF;">return</span> ( DONT_INTERSECT );
  
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Compute a2, b2, c2 */</span>
  
    a2 = p4.y - p3.y;
    b2 = p3.x - p4.x;
    c2 = p4.x * p3.y - p3.x * p4.y;
  
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Compute r1 and r2 */</span>
  
    r1 = a2 * p1.x + b2 * p1.y + c2;
    r2 = a2 * p2.x + b2 * p2.y + c2;
  
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Check signs of r1 and r2.  If both point 1 and point 2 lie</span>
<span style="color: #8D8D84; font-style: italic;">     * on same side of second line segment, the line segments do</span>
<span style="color: #8D8D84; font-style: italic;">     * not intersect.</span>
<span style="color: #8D8D84; font-style: italic;">     */</span>
  
    <span style="color: #0000FF;">if</span> ( r1 !== 0 &amp;&amp;
         r2 !== 0 &amp;&amp;
         sameSigns( r1, r2 ))
      <span style="color: #0000FF;">return</span> ( DONT_INTERSECT );

    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Line segments intersect: compute intersection point. </span>
<span style="color: #8D8D84; font-style: italic;">     */</span>
  
    denom = a1 * b2 - a2 * b1;
    <span style="color: #0000FF;">if</span> ( denom === 0 )
      <span style="color: #0000FF;">return</span> ( COLLINEAR );
    offset = denom &lt; 0 ? - denom / 2 : denom / 2;
  
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">The denom/2 is to get rounding instead of truncating.  It</span>
<span style="color: #8D8D84; font-style: italic;">     * is added or subtracted to the numerator, depending upon the</span>
<span style="color: #8D8D84; font-style: italic;">     * sign of the numerator.</span>
<span style="color: #8D8D84; font-style: italic;">     */</span>
  
    num = b1 * c2 - b2 * c1;
    p5.x = ( num &lt; 0 ? num - offset : num + offset ) / denom;
  
    num = a2 * c1 - a1 * c2;
    p5.y = ( num &lt; 0 ? num - offset : num + offset ) / denom;

    <span style="color: #0000FF;">return</span> DO_INTERSECT;
  } <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">lines_intersect */</span>

  <span style="color: #0000FF;">function</span> <span style="color: #006699;">lineRectIntersect</span>(<span style="color: #BA36A5;">p1</span>, <span style="color: #BA36A5;">p2</span>, <span style="color: #BA36A5;">r</span>) {
    <span style="color: #0000FF;">if</span> (!intersect(rect(p1, p2), r)) <span style="color: #0000FF;">return</span> <span style="color: #8b1a1a;">false</span>; <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">if bounding boxes do not overlap, cannot intersect</span>
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">p</span> = {};
    <span style="color: #0000FF;">if</span> (lineIntersect(p1, p2, { x: r.left, y: r.top }, { x: r.left, y: r.bottom }, p) !== 0) <span style="color: #0000FF;">return</span> <span style="color: #8b1a1a;">true</span>;
    <span style="color: #0000FF;">if</span> (lineIntersect(p1, p2, { x: r.left, y: r.top }, { x: r.right, y: r.top }, p) !== 0) <span style="color: #0000FF;">return</span> <span style="color: #8b1a1a;">true</span>;
    <span style="color: #0000FF;">if</span> (lineIntersect(p1, p2, { x: r.right, y: r.bottom }, { x: r.right, y: r.top }, p) !== 0) <span style="color: #0000FF;">return</span> <span style="color: #8b1a1a;">true</span>;
    <span style="color: #0000FF;">if</span> (lineIntersect(p1, p2, { x: r.right, y: r.bottom }, { x: r.left, y: r.bottom }, p) !== 0) <span style="color: #0000FF;">return</span> <span style="color: #8b1a1a;">true</span>;
    <span style="color: #0000FF;">return</span> pointInRect(p1, r) || pointInRect(p2, r);
  }
</pre>
</div>
</div>
</div>



<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Drawing anchors, cursors, and rubber bands on Canvas</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">Rect</span> = require(<span style="color: #008000;">"./rectangle"</span>);

<span style="color: #0000FF;">function</span> <span style="color: #006699;">createBaseCanvas</span> (<span style="color: #BA36A5;">parent</span>) {
  <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">canvas</span> = document.createElement(<span style="color: #008000;">"canvas"</span>);
  <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">rect</span> = parent.getBoundingClientRect();
  canvas.style.position = <span style="color: #008000;">'absolute'</span>;
  canvas.width=Rect.width(rect);
  canvas.height=Rect.height(rect);
  canvas.style.zIndex = 0;
  canvas.style.overflow = <span style="color: #008000;">'hidden'</span>;
  parent.insertBefore(canvas, parent.firstChild);
  <span style="color: #0000FF;">return</span> canvas;
}

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Create n canvases on top of the baseCanvas, insert them into</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">the DOM, and push them into layerArray, and return layerArray.</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">The zIndex</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">is consequtive, up from baseCanvas's zIndex.  New canvases have</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">no border or background.</span>
<span style="color: #0000FF;">function</span> <span style="color: #006699;">createLayers</span> (<span style="color: #BA36A5;">baseCanvas</span>, <span style="color: #BA36A5;">n</span>, <span style="color: #BA36A5;">layers</span>) {
  <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">z</span> = baseCanvas.style.zIndex || 0;
  layers = layers || [];
  <span style="color: #0000FF;">for</span> (<span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">i</span> = 0; i &lt; n; ++i) {
    <span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">canvas</span> = baseCanvas.cloneNode(<span style="color: #8b1a1a;">true</span>);
    canvas.style.position = <span style="color: #008000;">'absolute'</span>;
    canvas.style.top = baseCanvas.style.top;
    canvas.style.left = baseCanvas.style.left;
    canvas.style.zIndex = z + 1 + i;
    canvas.style.background = <span style="color: #8b1a1a;">null</span>;
    layers.push(canvas);
    baseCanvas.parentNode.insertBefore(canvas, baseCanvas);            
  }
  <span style="color: #0000FF;">return</span> layers;
};

<span style="color: #8D8D84;">//////////////////////</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Cursor    canvas //</span>
<span style="color: #8D8D84;">//////////////////////</span>

exports.CursorCanvas = <span style="color: #0000FF;">function</span> (<span style="color: #BA36A5;">parent</span>) {
  
  <span style="color: #8b1a1a;">this</span>.baseCanvas = createBaseCanvas(parent);
  <span style="color: #8b1a1a;">this</span>.layers = createLayers(<span style="color: #8b1a1a;">this</span>.baseCanvas, 3, []);
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">construct 3 layers, one each for activeEnd, anchor, rubber</span>

<span style="color: #8D8D84;">//  </span><span style="color: #8D8D84; font-style: italic;">this.eventCanvas = this.layers[this.layers.length-1];</span>
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">last layer captures mouse events</span>

  <span style="color: #8b1a1a;">this</span>.rubberCtx = <span style="color: #8b1a1a;">this</span>.layers[0].getContext(<span style="color: #008000;">'2d'</span>); 
  <span style="color: #8b1a1a;">this</span>.anchorCtx = <span style="color: #8b1a1a;">this</span>.layers[1].getContext(<span style="color: #008000;">'2d'</span>); 
  <span style="color: #8b1a1a;">this</span>.cursorCtx = <span style="color: #8b1a1a;">this</span>.layers[2].getContext(<span style="color: #008000;">'2d'</span>);
  
  <span style="color: #8b1a1a;">this</span>.anchorCtx.strokeStyle = <span style="color: #008000;">'blue'</span>;
  <span style="color: #8b1a1a;">this</span>.anchorCtx.lineWidth = 1;
  
  <span style="color: #8b1a1a;">this</span>.cursorCtx.strokeStyle = <span style="color: #008000;">'deeppink'</span>;
  <span style="color: #8b1a1a;">this</span>.cursorCtx.lineWidth = 1;
  
  <span style="color: #8b1a1a;">this</span>.rubberCtx.strokeStyle = <span style="color: #008000;">'darkgreen'</span>;
  <span style="color: #8b1a1a;">this</span>.rubberCtx.lineWidth = 2;
  <span style="color: #0000FF;">if</span> (<span style="color: #8b1a1a;">this</span>.rubberCtx.setLineDash) 
    <span style="color: #8b1a1a;">this</span>.rubberCtx.setLineDash([6,3]); <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Not in all browsers</span>
}

exports.CursorCanvas.<span style="color: #8b1a1a;">prototype</span>.resize = <span style="color: #0000FF;">function</span> (<span style="color: #BA36A5;">w</span>, <span style="color: #BA36A5;">h</span>) {        
  <span style="color: #0000FF;">for</span> (<span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">i</span> = 0; i &lt; <span style="color: #8b1a1a;">this</span>.layers.length; ++i) {
    <span style="color: #8b1a1a;">this</span>.layers[i].width = w;
    <span style="color: #8b1a1a;">this</span>.layers[i].height = h;          
  }
};

exports.CursorCanvas.<span style="color: #8b1a1a;">prototype</span>.clear = <span style="color: #0000FF;">function</span> (<span style="color: #BA36A5;">ctx</span>) {
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
}


<span style="color: #8D8D84;">//////////////////////////////////////////////////////</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Helper functions for drawing shapes on a context //</span>
<span style="color: #8D8D84;">//////////////////////////////////////////////////////</span>

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">pre: objects in path have members x and y</span>
exports.drawPath = <span style="color: #0000FF;">function</span> (<span style="color: #BA36A5;">ctx</span>, <span style="color: #BA36A5;">path</span>) {    
  <span style="color: #0000FF;">if</span> (path.length &lt; 2) <span style="color: #0000FF;">return</span>;
  ctx.beginPath();
  ctx.moveTo(path[0].x, path[0].y);
  <span style="color: #0000FF;">for</span> (<span style="color: #0000FF;">var</span> <span style="color: #BA36A5;">i</span>=1; i&lt;path.length; ++i) ctx.lineTo(path[i].x, path[i].y);
  ctx.stroke();
}

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">pre: r is a rect</span>
exports.drawBox = <span style="color: #0000FF;">function</span> (<span style="color: #BA36A5;">ctx</span>, <span style="color: #BA36A5;">r</span>) {
  ctx.strokeRect(r.left, r.top, Rect.width(r), Rect.height(r));

}

exports.drawLine = <span style="color: #0000FF;">function</span> (<span style="color: #BA36A5;">ctx</span>, <span style="color: #BA36A5;">p1</span>, <span style="color: #BA36A5;">p2</span>) {
  ctx.beginPath();
  ctx.moveTo(p1.x, p1.y);
  ctx.lineTo(p2.x, p2.y);
  ctx.stroke();
}

exports.drawCircle = <span style="color: #0000FF;">function</span> (<span style="color: #BA36A5;">ctx</span>, <span style="color: #BA36A5;">point</span>) {
  ctx.beginPath();
  ctx.arc(point.x, point.y, 4, 0, Math.PI*2, <span style="color: #8b1a1a;">true</span>); 
  ctx.stroke();
}

exports.drawSmallCircle = <span style="color: #0000FF;">function</span> (<span style="color: #BA36A5;">ctx</span>, <span style="color: #BA36A5;">point</span>) {
  ctx.beginPath();
  ctx.arc(point.x, point.y, 2, 0, Math.PI*2, <span style="color: #8b1a1a;">true</span>); 
  ctx.stroke();
}
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
