(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.multiselect=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";function makeEmptySet(){return new Set}function makeEmptyMap(){return new Map}function isEmpty(collection){return collection.size===0}function isSingleton(collection){return collection.size===1}function firstKey(collection){return collection.keys().next().value}function copySet(s){var s2=makeEmptySet();s.forEach(function(key){s2.add(key)});return s2}function copyMap(s){var s2=makeEmptyMap();s.forEach(function(value,key){s2.set(key,value)});return s2}function equalKeys(a,b){if(a.size!==b.size)return false;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=a.keys()[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var i=_step.value;if(!b.has(i))return false}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator["return"]){_iterator["return"]()}}finally{if(_didIteratorError){throw _iteratorError}}}return true}function setUnion(){var s=makeEmptySet();for(var i=0;i<arguments.length;++i){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=arguments[i].keys()[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var j=_step2.value;s.add(j)}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2["return"]){_iterator2["return"]()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}return s}function mapSymmetricDifference(left,right,leftValue,rightValue){var s=makeEmptyMap();var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=left.keys()[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var i=_step3.value;if(!right.has(i))s.set(i,leftValue)}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3["return"]){_iterator3["return"]()}}finally{if(_didIteratorError3){throw _iteratorError3}}}var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=right.keys()[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var i=_step4.value;if(!left.has(i))s.set(i,rightValue)}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4["return"]){_iterator4["return"]()}}finally{if(_didIteratorError4){throw _iteratorError4}}}return s}var M_NONE=1,M_SHIFT=2,M_CMD=3,M_SHIFT_CMD=4,M_OPT=5,M_SHIFT_OPT=6;function modifierKeys(evt){if(evt.shiftKey&&isCmdKey(evt))return M_SHIFT_CMD;if(isCmdKey(evt))return M_CMD;if(evt.shiftKey&&evt.altKey)return M_SHIFT_OPT;if(evt.altKey)return M_OPT;if(evt.shiftKey)return M_SHIFT;return M_NONE;function isCmdKey(evt){return evt.metaKey||evt.ctrlKey}}function tt(_){return true}tt.constant=true;function ff(_){return false}ff.constant=true;function id(b){return b}id.constant=false;function not(b){return!b}not.constant=false;function makeSelectionMapping(){var s=makeEmptySet();var func=function func(i){return s.has(i)};func.set=function(i,v){if(v===true)s.add(i);else s["delete"](i)};func.selected=function(){return s.keys()};func.bake=function(op){var s2=op(func);op.domain.forEach(function(_,i){func.set(i,s2(i))})};return func}function makeOp(f,domain){var func;if(f.constant){func=function(s){return function(i){return domain.has(i)?f():s(i)}}}else{func=function(s){return function(i){return domain.has(i)?f(s(i)):s(i)}}}func.f=f;func.domain=domain;return func}function makeOpComposition(){var ops=[];var domain=makeEmptyMap();var gen=0;var func=function func(s){return function(i){return evaluate(domain.has(i)?ops.length-1-(gen-domain.get(i)):-1,i)(i)};function evaluate(ind,i){if(ind<0)return s;else{var op=ops[ind];return op(function(j){return evaluate(ind-op.domain.get(i),j)(i)})}}};func.domain=domain;func.push=function(op){ops.push(op);++gen;op.domain.forEach(function(_,i){op.domain.set(i,domain.has(i)?gen-domain.get(i):ops.length);domain.set(i,gen)})};func.pop=function(){var n=ops.length;var op=ops.pop();--gen;op.domain.forEach(function(_,i){if(op.domain.get(i)>=n)domain["delete"](i);else domain.set(i,domain.get(i)-op.domain.get(i))});return op};func.top=function(){return ops[ops.length-1]};func.top2=function(){return ops[ops.length-2]};func.shift=function(bmap){var op=ops.shift();op.domain.forEach(function(_,i){if(domain.get(i)-gen===ops.length){domain["delete"](i)}});return op};func.size=function(){return ops.length};func.removeIndex=function(i){if(!domain.has(i))return;var j=ops.length-1-(gen-domain.get(i));while(j>=0){var d=ops[j].domain.get(i);ops[j].domain["delete"](i);j-=d}domain["delete"](i)};return func}function SelectionState(geometry,refresh,tracking,maxUndo){if(refresh===undefined)refresh=function(){};if(tracking===undefined)tracking=false;if(maxUndo===undefined)maxUndo=10;this._geometry=geometry;this._tracking=tracking;this._refresh=refresh;this._maxOps=Math.max(2,2*maxUndo);this.reset()}SelectionState.prototype.reset=function(){this._s=makeSelectionMapping();this._ops=makeOpComposition();this._spath=[];this._cursor=undefined;this._redoStack=[];this._current=this._ops(this._s);this._opsStatus=ACTIVE_NONE;this._queuedCommand=function(){}};var ACTIVE_NONE=0,ACTIVE_FILTER=1,ACTIVE_SHIFT_CLICK_OR_SET_PATH=2;var C_SHIFT_CLICK=0,C_SET_PATH=1;SelectionState.prototype.isSelected=function(i){this._flush();return this._current(i)};SelectionState.prototype.selected=function(){this._flush();var J=makeEmptySet();var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=this._s.selected()[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var i=_step5.value;if(this._current(i))J.add(i)}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5["return"]){_iterator5["return"]()}}finally{if(_didIteratorError5){throw _iteratorError5}}}var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=this._ops.domain.keys()[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var i=_step6.value;if(this._current(i))J.add(i)}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally{try{if(!_iteratorNormalCompletion6&&_iterator6["return"]){_iterator6["return"]()}}finally{if(_didIteratorError6){throw _iteratorError6}}}return J};SelectionState.prototype.click=function(vp){this._flush();this._spath=[];if(this._geometry.extendPath(this._spath,vp)!==null)this._cursor=vp;var J1=this._callSelectionDomain(this._spath);if(clickIsNop.call(this,J1))return this;var J0=makeEmptyMap();var _iteratorNormalCompletion7=true;var _didIteratorError7=false;var _iteratorError7=undefined;try{for(var _iterator7=this._s.selected()[Symbol.iterator](),_step7;!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=true){var i=_step7.value;if(this._current(i))J0.set(i,true)}}catch(err){_didIteratorError7=true;_iteratorError7=err}finally{try{if(!_iteratorNormalCompletion7&&_iterator7["return"]){_iterator7["return"]()}}finally{if(_didIteratorError7){throw _iteratorError7}}}var _iteratorNormalCompletion8=true;var _didIteratorError8=false;var _iteratorError8=undefined;try{for(var _iterator8=this._ops.domain.keys()[Symbol.iterator](),_step8;!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=true){var i=_step8.value;if(this._current(i))J0.set(i,true)}}catch(err){_didIteratorError8=true;_iteratorError8=err}finally{try{if(!_iteratorNormalCompletion8&&_iterator8["return"]){_iterator8["return"]()}}finally{if(_didIteratorError8){throw _iteratorError8}}}this._ops.push(makeOp(ff,J0));this._ops.push(makeOp(tt,J1));this._bake();this._opsStatus=ACTIVE_SHIFT_CLICK_OR_SET_PATH;if(this._tracking)this._refresh(mapSymmetricDifference(J0,J1,false,true));else this._refresh(this._current);return this};function clickIsNop(J){return this._ops.size()>=2&&this._ops.top2().f===ff&&this._ops.top().f===tt&&equalKeys(J,this._ops.top().domain)}SelectionState.prototype.cmdClick=function(vp,selmode){this._flush();this._spath=[];if(this._geometry.extendPath(this._spath,vp)!==null)this._cursor=vp;var J=this._callSelectionDomain(this._spath);var mode;if(selmode===undefined)mode=this._onSelectedIndex(J)?ff:tt;else mode=selmode?tt:ff;if(cmdClickIsNop.call(this,J,mode))return this;var changed=makeEmptyMap();if(this._tracking){var _iteratorNormalCompletion9=true;var _didIteratorError9=false;var _iteratorError9=undefined;try{for(var _iterator9=J.keys()[Symbol.iterator](),_step9;!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=true){var i=_step9.value;var state=this._current(i);if(state!==mode(state))changed.set(i,mode(state))}}catch(err){_didIteratorError9=true;_iteratorError9=err}finally{try{if(!_iteratorNormalCompletion9&&_iterator9["return"]){_iterator9["return"]()}}finally{if(_didIteratorError9){throw _iteratorError9}}}}this._ops.push(makeOp(id,makeEmptyMap()));this._ops.push(makeOp(mode,J));this._bake();this._opsStatus=ACTIVE_SHIFT_CLICK_OR_SET_PATH;this._refresh(this._tracking?changed:this._current);return this};function cmdClickIsNop(J,mode){return this._ops.size()>=2&&this._ops.top2().f===id&&this._ops.top().f===mode&&isEmpty(J)&&isEmpty(this._ops.top().domain)}SelectionState.prototype.shiftClick=function(vp){if(this._geometry.extendPath(this._spath,vp)===null)return this;this._cursor=this._spath[this._spath.length-1];if(this._queuedCommand.pending&&this._queuedCommand.type===C_SHIFT_CLICK)return this;else this._flush();this._queuedCommand=mkDelayedCommand(this,C_SHIFT_CLICK);setTimeout(this._queuedCommand,0);return this};function mkDelayedCommand(sel,cmdType){var cmd=function cmd(){if(cmd.pending===false)return null;cmd.pending=false;if(sel._opsStatus!==ACTIVE_SHIFT_CLICK_OR_SET_PATH){sel._opsStatus=ACTIVE_SHIFT_CLICK_OR_SET_PATH;sel._addEmptyPair()}var changed=makeEmptyMap();var op=sel._ops.pop();var mode=op.f;var oldJ=sel._tracking?copyMap(op.domain):op.domain;var J=sel._callSelectionDomain(sel._spath,cmdType,oldJ);if(sel._tracking){mapSymmetricDifference(J,op.domain,true,false).forEach(function(value,i){var tmp=sel._current(i);if(mode(tmp)===tmp)return;if(value)changed.set(i,mode(tmp));else changed.set(i,tmp)}.bind(sel))}sel._ops.push(makeOp(mode,J));sel._refresh(sel._tracking?changed:sel._current)};cmd.pending=true;cmd.type=cmdType;return cmd}SelectionState.prototype._callSelectionDomain=function(path,cmdType,J){if(cmdType===undefined||cmdType!==this._previousCmdType){this._previousCmdType=cmdType;if(path.length===0)return makeEmptyMap();return this._geometry.selectionDomain(path)}else{if(path.length===0)return makeEmptyMap();return this._geometry.selectionDomain(path,cmdType,J)}};SelectionState.prototype.setPath=function(path){this._spath=path;this._cursor=activeEnd(path);if(this._queuedCommand.pending&&this._queuedCommand.type===C_SET_PATH)return this;else this._flush();this._queuedCommand=mkDelayedCommand(this,C_SET_PATH);setTimeout(this._queuedCommand,0);return this};SelectionState.prototype._flush=function(){this._queuedCommand()};SelectionState.prototype.onSelected=function(vp){this._flush();var path=[];if(this._geometry.extendPath(path,vp)===null)return false;var J=this._callSelectionDomain(path);return this._onSelectedIndex(J)};SelectionState.prototype._onSelectedIndex=function(J){return isSingleton(J)&&this.isSelected(firstKey(J))};SelectionState.prototype._addEmptyPair=function(){this._ops.push(makeOp(id,makeEmptyMap()));this._ops.push(makeOp(tt,makeEmptyMap()))};SelectionState.prototype._bake=function(){if(this._ops.size()>this._maxOps){this._s.bake(this._ops.shift());this._s.bake(this._ops.shift())}};SelectionState.prototype.undo=function(){this._flush();this._spath=[];var changed=makeEmptyMap();if(this._ops.size()>=2){if(this._tracking){var _iteratorNormalCompletion10=true;var _didIteratorError10=false;var _iteratorError10=undefined;try{for(var _iterator10=this._ops.top().domain.keys()[Symbol.iterator](),_step10;!(_iteratorNormalCompletion10=(_step10=_iterator10.next()).done);_iteratorNormalCompletion10=true){var i=_step10.value;changed.set(i,this._current(i))}}catch(err){_didIteratorError10=true;_iteratorError10=err}finally{try{if(!_iteratorNormalCompletion10&&_iterator10["return"]){_iterator10["return"]()}}finally{if(_didIteratorError10){throw _iteratorError10}}}var _iteratorNormalCompletion11=true;var _didIteratorError11=false;var _iteratorError11=undefined;try{for(var _iterator11=this._ops.top2().domain.keys()[Symbol.iterator](),_step11;!(_iteratorNormalCompletion11=(_step11=_iterator11.next()).done);_iteratorNormalCompletion11=true){var i=_step11.value;changed.set(i,this._current(i))}}catch(err){_didIteratorError11=true;_iteratorError11=err}finally{try{if(!_iteratorNormalCompletion11&&_iterator11["return"]){_iterator11["return"]()}}finally{if(_didIteratorError11){throw _iteratorError11}}}}this._redoStack.push(this._ops.pop());this._redoStack.push(this._ops.pop())}if(this._tracking){var _iteratorNormalCompletion12=true;var _didIteratorError12=false;var _iteratorError12=undefined;try{for(var _iterator12=changed.keys()[Symbol.iterator](),_step12;!(_iteratorNormalCompletion12=(_step12=_iterator12.next()).done);_iteratorNormalCompletion12=true){var i=_step12.value;if(changed.get(i)===this._current(i))changed["delete"](i);else changed.set(i,this._current(i))}}catch(err){_didIteratorError12=true;_iteratorError12=err}finally{try{if(!_iteratorNormalCompletion12&&_iterator12["return"]){_iterator12["return"]()}}finally{if(_didIteratorError12){throw _iteratorError12}}}}if(this._redoStack.length>this._maxOps){this._redoStack.shift();this._redoStack.shift()}this._opsStatus=ACTIVE_NONE;this._refresh(this._tracking?changed:this._current);return this};SelectionState.prototype.redo=function(){this._flush();this._spath=[];var changed=makeEmptyMap();if(this._redoStack.length>=2){var op=this._redoStack.pop();if(this._tracking){var _iteratorNormalCompletion13=true;var _didIteratorError13=false;var _iteratorError13=undefined;try{for(var _iterator13=op.domain.keys()[Symbol.iterator](),_step13;!(_iteratorNormalCompletion13=(_step13=_iterator13.next()).done);_iteratorNormalCompletion13=true){var i=_step13.value;changed.set(i,this._current(i))}}catch(err){_didIteratorError13=true;_iteratorError13=err}finally{try{if(!_iteratorNormalCompletion13&&_iterator13["return"]){_iterator13["return"]()}}finally{if(_didIteratorError13){throw _iteratorError13}}}}this._ops.push(op);op=this._redoStack.pop();if(this._tracking){var _iteratorNormalCompletion14=true;var _didIteratorError14=false;var _iteratorError14=undefined;try{for(var _iterator14=op.domain.keys()[Symbol.iterator](),_step14;!(_iteratorNormalCompletion14=(_step14=_iterator14.next()).done);_iteratorNormalCompletion14=true){var i=_step14.value;changed.set(i,this._current(i))}}catch(err){_didIteratorError14=true;_iteratorError14=err}finally{try{if(!_iteratorNormalCompletion14&&_iterator14["return"]){_iterator14["return"]()}}finally{if(_didIteratorError14){throw _iteratorError14}}}}this._ops.push(op)}if(this._tracking){var _iteratorNormalCompletion15=true;var _didIteratorError15=false;var _iteratorError15=undefined;try{for(var _iterator15=changed.keys()[Symbol.iterator](),_step15;!(_iteratorNormalCompletion15=(_step15=_iterator15.next()).done);_iteratorNormalCompletion15=true){var i=_step15.value;if(changed.get(i)===this._current(i))changed["delete"](i);else changed.set(i,this._current(i))}}catch(err){_didIteratorError15=true;_iteratorError15=err}finally{try{if(!_iteratorNormalCompletion15&&_iterator15["return"]){_iterator15["return"]()}}finally{if(_didIteratorError15){throw _iteratorError15}}}}this._opsStatus=ACTIVE_NONE;this._refresh(this._tracking?changed:this._current);return this};SelectionState.prototype.setPath=function(path){this._spath=path;this._cursor=activeEnd(path);if(this._queuedCommand.pending&&this._queuedCommand.type===C_SET_PATH)return this;else this._flush();this._queuedCommand=mkDelayedCommand(this,C_SET_PATH);setTimeout(this._queuedCommand,0);return this};SelectionState.prototype.filter=function(predicate,state){if(state!==false)mode=tt;else mode=ff;this._flush();this._spath=[];if(this._opsStatus!==ACTIVE_FILTER||this._ops.size()>=2&&this._ops.top().f!==mode){this._opsStatus=ACTIVE_FILTER;this._addEmptyPair()}var changed=makeEmptyMap();var J=this._geometry.filter(predicate);var op=this._ops.pop();var self=this;if(this._tracking){mapSymmetricDifference(J,op.domain,true,false).forEach(function(value,i){var tmp=self._current(i);if(mode(tmp)===tmp)return;if(value)changed.set(i,mode(tmp));else changed.set(i,tmp)}.bind(self))}this._ops.push(makeOp(mode,J));this._refresh(this._tracking?changed:this._current);return this};SelectionState.prototype.commit=function(){this._flush();this._opsStatus=ACTIVE_NONE};SelectionState.prototype.setGeometry=function(geometry){this._flush();this._spath=[];this._cursor=undefined;this.commit();this._geometry=geometry;return this};SelectionState.prototype.geometry=function(){return this._geometry};SelectionState.prototype.cursor=function(){return this._cursor};SelectionState.prototype.selectionPath=function(){return this._spath};function valueOrDefault(a,def){return a===undefined?def:a}SelectionState.prototype.space=function(){if(!this._acquireCursor(NO_DIRECTION))return this;return this.click(this._cursor)};SelectionState.prototype.cmdSpace=function(dir){if(!this._acquireCursor(valueOrDefault(dir,NO_DIRECTION)))return this;return this.cmdClick(this._cursor)};SelectionState.prototype.shiftSpace=function(dir){if(!this._acquireCursor(valueOrDefault(dir,NO_DIRECTION)))return this;return this.shiftClick(this._cursor)};SelectionState.prototype.arrow=function(dir){if(this._noCursor()){this._acquireCursor(dir);return this}this._cursor=this._geometry.step(dir,this._cursor);return this};SelectionState.prototype.cmdArrow=function(dir){if(this._noCursor())return this.cmdSpace(dir);else return this.cmdSpace(dir).arrow(dir)};SelectionState.prototype.shiftArrow=function(dir){if(this._noCursor())return this.shiftSpace(dir);else return this.arrow(dir).shiftSpace(dir)};SelectionState.prototype._acquireCursor=function(dir){this._cursor=valueOrDefault(this._cursor,this._geometry.defaultCursor(dir));return!this._noCursor()};SelectionState.prototype._noCursor=function(){return this._cursor===undefined};var DefaultGeometry=function DefaultGeometry(){};DefaultGeometry.prototype={m2v:function m2v(mp){return mp},extendPath:function extendPath(spath,vp){if(vp===null)return null;if(spath.length==2)spath[1]=vp;else spath.push(vp)},step:function step(dir,vp){return undefined},selectionDomain:function selectionDomain(spath,source,J){var m=makeEmptyMap();var _iteratorNormalCompletion16=true;var _didIteratorError16=false;var _iteratorError16=undefined;try{for(var _iterator16=spath[Symbol.iterator](),_step16;!(_iteratorNormalCompletion16=(_step16=_iterator16.next()).done);_iteratorNormalCompletion16=true){var i=_step16.value;m.set(i,true)}}catch(err){_didIteratorError16=true;_iteratorError16=err}finally{try{if(!_iteratorNormalCompletion16&&_iterator16["return"]){_iterator16["return"]()}}finally{if(_didIteratorError16){throw _iteratorError16}}}return m},defaultCursor:function defaultCursor(dir){return undefined},filter:undefined};var UP=1,DOWN=2,LEFT=3,RIGHT=4,NO_DIRECTION=0;function anchor(path){if(path.length===0)return undefined;return path[0]}function activeEnd(path){if(path.length===0)return undefined;return path[path.length-1]}exports.SelectionState=SelectionState;exports.Selection=Selection;exports.UP=UP;exports.DOWN=DOWN;exports.LEFT=LEFT;exports.RIGHT=RIGHT;exports.C_SHIFT_CLICK=C_SHIFT_CLICK;exports.C_SET_PATH=C_SET_PATH;exports.anchor=anchor;exports.activeEnd=activeEnd;exports.makeEmptyMap=makeEmptyMap;exports.DefaultGeometry=DefaultGeometry;exports.NONE=M_NONE;exports.SHIFT=M_SHIFT;exports.CMD=M_CMD;exports.SHIFT_CMD=M_SHIFT_CMD;exports.OPT=M_OPT;exports.SHIFT_OPT=M_SHIFT_OPT;exports.modifierKeys=modifierKeys;exports.detail={};exports.detail.tt=tt;exports.detail.ff=ff;exports.detail.not=not;exports.detail.id=id;exports.detail.makeOp=makeOp;exports.detail.makeEmptySet=makeEmptySet;exports.detail.makeEmptyMap=makeEmptyMap;exports.detail.makeSelectionMapping=makeSelectionMapping;exports.detail.makeOpComposition=makeOpComposition;exports.detail.equalKeys=equalKeys;exports.detail.isEmpty=isEmpty},{}],2:[function(require,module,exports){"use strict";module.exports=require("./multiselect");module.exports.Geometries=require("./selection_geometries")},{"./multiselect":1,"./selection_geometries":4}],3:[function(require,module,exports){"use strict";module.exports={rect:rect,point:point,midPoint:midPoint,getOffsetRect:getOffsetRect,getOffsetRects:getOffsetRects,pointInRect:pointInRect,pointInRects:pointInRects,findRectOfPoint:findRectOfPoint,pointToRect:pointToRect,union:union,intersect:intersect,intersectWithAny:intersectWithAny,width:width,height:height,lineIntersect:lineIntersect,lineRectIntersect:lineRectIntersect,distance:distance,distanceSquared:distanceSquared,distanceToRectSquared:distanceToRectSquared,isPointBelowRect:isPointBelowRect,isPointAboveRect:isPointAboveRect,isPointLeftOfRect:isPointLeftOfRect,isPointRightOfRect:isPointRightOfRect,within:within};function within(x,b,e){return x>=Math.min(b,e)&&x<=Math.max(b,e)}function relativeToParent(pRect,eRect){return{left:eRect.left-pRect.left,top:eRect.top-pRect.top,right:eRect.right-pRect.left,bottom:eRect.bottom-pRect.top}}function getOffsetRects(parent,elem){var parentBox=parent.getBoundingClientRect();var boxes=elem.getClientRects();var res=$.map(boxes,function(box){return relativeToParent(parentBox,box)});return res}function getOffsetRect(parent,elem){var parentBox=parent.getBoundingClientRect();var box=elem.getBoundingClientRect();return{left:box.left-parentBox.left,top:box.top-parentBox.top,right:box.right-parentBox.left,bottom:box.bottom-parentBox.top}}function rect(p1,p2){return{left:Math.min(p1.x,p2.x),top:Math.min(p1.y,p2.y),right:Math.max(p1.x,p2.x),bottom:Math.max(p1.y,p2.y)}}function point(x,y){return{x:x,y:y}}function midPoint(r){return{x:(r.left+r.right)/2,y:(r.top+r.bottom)/2}}function pointInRect(p,r){return p.x>=r.left&&p.x<=r.right&&p.y>=r.top&&p.y<=r.bottom}function pointInRects(p,rs){for(var i=0;i<rs.length;++i)if(pointInRect(p,rs[i]))return true;return false}function findRectOfPoint(p,rs){for(var i=0;i<rs.length;++i)if(pointInRect(p,rs[i]))return rs[i];return undefined}function isPointBelowRect(p,r){return p.y>=r.bottom}function isPointAboveRect(p,r){return p.y<=r.top}function isPointLeftOfRect(p,r){return p.x<=r.left}function isPointRightOfRect(p,r){return p.x>=r.right}function pointToRect(point){return{left:point.x,top:point.y,right:point.x,bottom:point.y}}function distance(p1,p2){return Math.sqrt(distanceSquared(p1,p2))}function distanceSquared(p1,p2){var dx=p2.x-p1.x;var dy=p2.y-p1.y;return dx*dx+dy*dy}function distanceToRectSquared(p,r){var cand=Math.min(distanceSquared(p,{x:r.left,y:r.top}),distanceSquared(p,{x:r.left,y:r.bottom}),distanceSquared(p,{x:r.right,y:r.top}),distanceSquared(p,{x:r.right,y:r.bottom}));if(p.x>r.left&&p.x<r.right)return Math.min(cand,Math.abs(p.y-r.top),Math.abs(p.y-r.bottom));if(p.y>r.top&&p.y<r.bottom)return Math.min(cand,Math.abs(p.x-r.left),Math.abs(p.x-r.right));return cand}function union(r1,r2){var left=Math.min(r1.left,r2.left);var top=Math.min(r1.top,r2.top);var right=Math.max(r1.right,r2.right);var bottom=Math.max(r1.bottom,r2.bottom);return{left:left,top:top,right:right,bottom:bottom}}function width(r){return r.right-r.left}function height(r){return r.bottom-r.top}function intersect(r1,r2){return r1.left<r2.right&&r1.right>r2.left&&r1.top<r2.bottom&&r1.bottom>r2.top}function intersectWithAny(r,rs){for(var i=0;i<rs.length;++i)if(intersect(r,rs[i]))return true;return false}function sameSigns(a,b){return a>=0&&b>=0||a<0&&b<0}function lineIntersect(p1,p2,p3,p4,p5){var DONT_INTERSECT=0;var DO_INTERSECT=1;var COLLINEAR=2;var a1,a2,b1,b2,c1,c2;var r1,r2,r3,r4;var denom,offset,num;a1=p2.y-p1.y;b1=p1.x-p2.x;c1=p2.x*p1.y-p1.x*p2.y;r3=a1*p3.x+b1*p3.y+c1;r4=a1*p4.x+b1*p4.y+c1;if(r3!=0&&r4!=0&&sameSigns(r3,r4))return DONT_INTERSECT;a2=p4.y-p3.y;b2=p3.x-p4.x;c2=p4.x*p3.y-p3.x*p4.y;r1=a2*p1.x+b2*p1.y+c2;r2=a2*p2.x+b2*p2.y+c2;if(r1!==0&&r2!==0&&sameSigns(r1,r2))return DONT_INTERSECT;denom=a1*b2-a2*b1;if(denom===0)return COLLINEAR;offset=denom<0?-denom/2:denom/2;num=b1*c2-b2*c1;p5.x=(num<0?num-offset:num+offset)/denom;num=a2*c1-a1*c2;p5.y=(num<0?num-offset:num+offset)/denom;return DO_INTERSECT}function lineRectIntersect(p1,p2,r){if(!intersect(rect(p1,p2),r))return false;var p={};if(lineIntersect(p1,p2,{x:r.left,y:r.top},{x:r.left,y:r.bottom},p)!==0)return true;if(lineIntersect(p1,p2,{x:r.left,y:r.top},{x:r.right,y:r.top},p)!==0)return true;if(lineIntersect(p1,p2,{x:r.right,y:r.bottom},{x:r.right,y:r.top},p)!==0)return true;if(lineIntersect(p1,p2,{x:r.right,y:r.bottom},{x:r.left,y:r.bottom},p)!==0)return true;return pointInRect(p1,r)||pointInRect(p2,r)}},{}],4:[function(require,module,exports){"use strict";var M=require("./multiselect");var Rect=require("./rectangle");var makeEmptyMap=M.detail.makeEmptyMap;var OrderedGeometry=function OrderedGeometry(size){M.DefaultGeometry.call(this);this._size=size};OrderedGeometry.prototype=Object.create(M.DefaultGeometry.prototype);OrderedGeometry.prototype.constructor=OrderedGeometry;OrderedGeometry.prototype.selectionDomain=function(spath){var J=makeEmptyMap();if(spath.length===0)return J;var b=Math.max(0,Math.min(M.anchor(spath),M.activeEnd(spath)));var e=Math.min(this._size-1,Math.max(M.anchor(spath),M.activeEnd(spath)));for(var i=b;i<=e;++i)J.set(i,true);return J};OrderedGeometry.prototype.filter=function(predicate){var J=makeEmptyMap();for(var i=0;i<this._size;++i)if(predicate(i))J.set(i,true);return J};OrderedGeometry.prototype.size=function(){return this._size};exports.OrderedGeometry=OrderedGeometry;var VerticalGeometry=function VerticalGeometry(size){OrderedGeometry.call(this,size)};VerticalGeometry.prototype=Object.create(OrderedGeometry.prototype);VerticalGeometry.prototype.constructor=VerticalGeometry;VerticalGeometry.prototype.step=function(dir,vpoint){switch(dir){case M.UP:return Math.max(0,vpoint-1);case M.DOWN:return Math.min(this._size-1,vpoint+1);default:return vpoint}};exports.VerticalGeometry=VerticalGeometry;var HorizontalGeometry=function HorizontalGeometry(size){OrderedGeometry.call(this,size)};HorizontalGeometry.prototype=Object.create(OrderedGeometry.prototype);HorizontalGeometry.prototype.constructor=HorizontalGeometry;HorizontalGeometry.prototype.step=function(dir,vpoint){switch(dir){case M.LEFT:return Math.max(0,vpoint-1);case M.RIGHT:return Math.min(this._size-1,vpoint+1);default:return vpoint}};exports.HorizontalGeometry=HorizontalGeometry;var DomGeometry=function DomGeometry(parent,elements){OrderedGeometry.call(this,elements.length);this._parent=parent;this._elements=elements};DomGeometry.prototype=Object.create(OrderedGeometry.prototype);DomGeometry.constructor=DomGeometry;DomGeometry.prototype.m2v=function(mpoint){for(var i=0;i<this._elements.length;++i){if(Rect.pointInRects(mpoint,Rect.getOffsetRects(this._parent,this._elements[i])))return i}return null};DomGeometry.prototype.step=function(dir,vpoint){switch(dir){case M.LEFT:return Math.max(0,vpoint-1);case M.RIGHT:return Math.min(this._size-1,vpoint+1);default:return vpoint}};DomGeometry.prototype.defaultCursor=function(dir){switch(dir){case M.LEFT:return this._size-1;case M.RIGHT:return 0;case M.NO_DIRECTION:return 0;default:return null}};exports.DomGeometry=DomGeometry;var IPhotoDomGeometry=function IPhotoDomGeometry(parent,elements){return DomGeometry.call(this,parent,elements)};IPhotoDomGeometry.prototype=Object.create(DomGeometry.prototype);IPhotoDomGeometry.constructor=IPhotoDomGeometry;IPhotoDomGeometry.prototype.m2v=function(mpoint){for(var i=0;i<this._elements.length;++i){if(Rect.pointInRects(mpoint,Rect.getOffsetRects(this._parent,this._elements[i])))return{index:i,location:mpoint}}return{index:undefined,location:mpoint}};IPhotoDomGeometry.prototype.v2m=function(mpoint){if(mpoint===undefined)return mpoint;if(mpoint.location!==undefined)return mpoint.location;return Rect.midPoint(Rect.getOffsetRects(this._parent,this._elements[mpoint.index])[0])};IPhotoDomGeometry.prototype.vpath2mpath=function(vpath){return vpath.map(function(mp){return mp.location})};IPhotoDomGeometry.prototype.defaultCursor=function(dir){switch(dir){case M.RIGHT:return{index:-1};case M.LEFT:return{index:this._size};default:return undefined}};IPhotoDomGeometry.prototype.step=function(dir,vpoint){if(vpoint.index===undefined)return vpoint;switch(dir){case M.LEFT:return{index:Math.max(0,vpoint.index-1)};case M.RIGHT:return{index:Math.min(this._size-1,vpoint.index+1)};default:return vpoint}};IPhotoDomGeometry.prototype.boundToElement=function(vpoint){return vpoint.index!==undefined};IPhotoDomGeometry.prototype.extendPath=function(spath,vpoint){if(spath.length===0)return[];if(this.boundToElement(anchor(spath))){if(!this.boundToElement(vpoint))return spath}else{vpoint.index=undefined}spath.push(vpoint);return spath};IPhotoDomGeometry.prototype.selectionDomain=function(spath){var J=makeEmptyMap();if(spath.length===0)return J;if(this.boundToElement(anchor(spath))){return DomGeometry.prototype.selectionDomain.call(this,spath.map(function(v){return v.index}))}else{var bbox=Rect.rect(anchor(spath).location,M.activeEnd(spath).location);for(var i=0;i<this._elements.length;++i){if(Rect.intersectWithAny(bbox,Rect.getOffsetRects(this._parent,this._elements[i])))J.set(i,true)}}return J};exports.IPhotoDomGeometry=IPhotoDomGeometry},{"./multiselect":1,"./rectangle":3}]},{},[2])(2)});
